{"version":3,"file":"stripe_payment.min.js","sources":["../src/stripe_payment.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\ndefine([\"core/ajax\"], function (ajax) {\n  const { call: fetchMany } = ajax;\n\n  // Repository functions following ajaxdoc guidelines\n  const applyCoupon = (couponid, instanceid) =>\n    fetchMany([{ methodname: \"moodle_stripepayment_applycoupon\", args: { couponid, instanceid } }])[0];\n\n  const stripeenrol = (userid, couponid, instanceid) =>\n    fetchMany([{ methodname: \"moodle_stripepayment_enrol\", args: { userid, couponid, instanceid } }])[0];\n\n  // Optimized DOM utility with caching\n  const createDOM = (instanceid) => {\n    const cache = new Map();\n    return {\n      getelement(id) {\n        const fullid = `${id}-${instanceid}`;\n        if (!cache.has(fullid)) {\n          cache.set(fullid, document.getElementById(fullid));\n        }\n        return cache.get(fullid);\n      },\n      setelement(id, html) {\n        const element = this.getelement(id);\n        if (element) {\n          element.innerHTML = html;\n        }\n      },\n      toggleelement(id, show) {\n        const element = this.getelement(id);\n        if (element) {\n          element.style.display = show ? \"block\" : \"none\";\n        }\n      },\n      focuselement(id) {\n        const element = this.getelement(id);\n        if (element) {\n          element.focus();\n        }\n      },\n      setbutton(id, disabled, text, opacity = disabled ? \"0.7\" : \"1\") {\n        const button = this.getelement(id);\n        if (button) {\n          button.disabled = disabled;\n          button.textContent = text;\n          button.style.opacity = opacity;\n          button.style.cursor = disabled ? \"not-allowed\" : \"pointer\";\n        }\n      },\n    };\n  };\n  return {\n    stripe_payment: function (userid, publishablekey, couponid, instanceid, pleasewaitstring, entercoupon, couponappling) {\n      const DOM = createDOM(instanceid);\n      if (typeof window.Stripe === \"undefined\") {\n        return;\n      }\n      const applyCouponHandler = async (event) => {\n        event.preventDefault();\n        const couponinput = DOM.getelement(\"coupon\");\n        const couponcode = couponinput?.value.trim();\n        if (!couponcode) {\n          displayMessage(\"showmessage\", entercoupon, \"error\");\n          DOM.focuselement(\"coupon\");\n          return;\n        }\n        DOM.setbutton(\"apply\", true, couponappling);\n        try {\n          const data = await applyCoupon(couponcode, instanceid);\n          if (data?.status !== undefined) {\n            couponid = couponcode;\n            DOM.toggleelement(\"coupon\", false);\n            DOM.toggleelement(\"apply\", false);\n            updateUIFromServerResponse(data);\n          } else {\n            throw new Error(\"Invalid server response\");\n          }\n        } catch (error) {\n          displayMessage(\"showmessage\", error.message || \"Coupon validation failed\", \"error\");\n          DOM.focuselement(\"coupon\");\n        }\n      };\n\n      const EnrollHandler = async () => {\n        const enrollbutton = DOM.getelement(\"enrolbutton\");\n        if (!enrollbutton) {\n          return;\n        }\n        clearError(\"paymentresponse\");\n        DOM.setbutton(\"enrolbutton\", true, pleasewaitstring);\n        try {\n          const paymentdata = await stripeenrol(userid, couponid, instanceid);\n          if (paymentdata.error?.message) {\n            displayMessage(\"paymentresponse\", paymentdata.error.message, \"error\");\n          } else if (paymentdata.status === \"success\" && paymentdata.redirecturl) {\n            window.location.href = paymentdata.redirecturl;\n          } else {\n            displayMessage(\"paymentresponse\", \"Unknown error occurred during payment.\", \"error\");\n          }\n        } catch (err) {\n          displayMessage(\"paymentresponse\", err.message, \"error\");\n        } finally {\n          DOM.toggleelement(\"enrolbutton\", false);\n        }\n      };\n\n      const displayMessage = (containerid, message, type) => {\n        let color;\n        switch (type) {\n          case \"error\":\n            color = \"red\";\n            break;\n          case \"success\":\n            color = \"green\";\n            break;\n          default:\n            color = \"blue\";\n            break;\n        }\n        DOM.setelement(containerid, `<p style=\"color: ${color}; font-weight: bold;\">${message}</p>`);\n        DOM.toggleelement(containerid, true);\n      };\n\n      const clearError = (containerid) => {\n        DOM.setelement(containerid, \"\");\n        DOM.toggleelement(containerid, false);\n      };\n\n      const updateUIFromServerResponse = (data) => {\n        if (data.message) {\n          displayMessage(\"showmessage\", data.message, data.uistate === \"error\" ? \"error\" : \"success\");\n        } else {\n          clearError(\"showmessage\");\n        }\n        DOM.toggleelement(\"enrolbutton\", data.uistate === \"paid\");\n        DOM.toggleelement(\"total\", data.uistate === \"paid\");\n        if (data.uistate !== \"error\") {\n          DOM.toggleelement(\"discountsection\", data.showsections.discountsection);\n          if (data.showsections.discountsection) {\n            if (data.couponname) {\n              DOM.setelement(\"discounttag\", data.couponname);\n            }\n            if (data.discountamount && data.currency) {\n              DOM.setelement(\"discountamountdisplay\", `-${data.currency} ${parseFloat(data.discountamount).toFixed(2)}`);\n            }\n            if (data.discountamount && data.discountvalue) {\n              const note = data.discountamount === \"percentoff\"\n                ? `${data.discountvalue}% off`\n                : `${data.currency} ${parseFloat(data.discountvalue).toFixed(2)} off`;\n              DOM.setelement(\"discountnote\", note);\n            }\n          }\n          if (data.status && data.currency) {\n            const totalamount = DOM.getelement(\"totalamount\");\n            if (totalamount) {\n              totalamount.textContent = `${data.currency} ${parseFloat(data.status).toFixed(2)}`;\n            }\n          }\n        }\n      };\n\n      const setupEventListeners = () => {\n        const elements = [\n          { id: \"apply\", event: \"click\", handler: applyCouponHandler },\n          { id: \"enrolbutton\", event: \"click\", handler: EnrollHandler },\n        ];\n        elements.forEach(({ id, event, handler }) => {\n          const element = DOM.getelement(id);\n          if (element) {\n            element.addEventListener(event, handler);\n          }\n        });\n      };\n      setupEventListeners();\n    },\n  };\n});"],"names":["define","ajax","call","fetchMany","createDOM","instanceid","cache","Map","getelement","id","fullid","has","set","document","getElementById","get","setelement","html","element","this","innerHTML","toggleelement","show","style","display","focuselement","focus","setbutton","disabled","text","opacity","arguments","length","undefined","button","textContent","cursor","stripe_payment","userid","publishablekey","couponid","pleasewaitstring","entercoupon","couponappling","DOM","window","Stripe","applyCouponHandler","async","event","preventDefault","couponinput","couponcode","value","trim","displayMessage","data","applyCoupon","methodname","args","status","Error","updateUIFromServerResponse","error","message","EnrollHandler","clearError","_paymentdata$error","paymentdata","stripeenrol","redirecturl","location","href","err","containerid","type","color","uistate","showsections","discountsection","couponname","discountamount","currency","parseFloat","toFixed","discountvalue","note","totalamount","handler","forEach","_ref","addEventListener"],"mappings":"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"}