define(["core/ajax","core/str"],function(e,n){"use strict";function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var t=o(e),s=o(n);const{call:r}=t.default;let p={};return{stripePayment:(e,n,o)=>{const t=new Map,a=e=>{const n=`${e}-${o}`;return t.has(n)||t.set(n,document.getElementById(n)),t.get(n)},c=(e,n)=>{const o=a(e);o&&(o.innerHTML=n)},i=(e,n)=>{const o=a(e);o&&(o.style.display=n?"block":"none")},l=e=>{const n=a(e);n&&n.focus()},u=(e,n,o,t=(n?"0.7":"1"))=>{const s=a(e);s&&(s.disabled=n,s.textContent=o,s.style.opacity=t,s.style.cursor=n?"not-allowed":"pointer")},d=(e,n,o)=>{let t;switch(o){case"error":t="red";break;case"success":t="green";break;default:t="blue"}c(e,`<p style="color: ${t}; font-weight: bold;">${n}</p>`),i(e,!0)},y=async e=>{e.preventDefault();const t=a("coupon"),s=t?.value.trim();if(!s)return d("showmessage",p.entercoupon,"error"),void l("coupon");u("apply",!0,p.couponappling);try{const e=await((e,n)=>r([{methodname:"moodle_stripepayment_apply_coupon",args:{couponid:e,instanceid:n}}])[0])(s,o);if(void 0===e?.discountedcost)throw new Error(p.invalidserverresponse);n=s,i("coupon",!1),i("apply",!1),m(e)}catch(e){d("showmessage",e.message,"error"),l("coupon")}finally{u("apply",!1,p.couponapply)}},m=e=>{i("discountsection",e.showsections.discountsection),e.showsections.discountsection&&(c("discounttag",e.couponname),c("discountamountdisplay",e.discountamount),c("discountnote",e.discountdisplay),c("totalamount",e.discountedcost),d("showmessage",p.couponappliedsuccessfully,"success")),u("enrolbutton",!1,p.enrolnow)},w=async()=>{var t;c(t="paymentresponse",""),i(t,!1),u("enrolbutton",!0,p.pleasewait);try{const t=await((e,n,o)=>r([{methodname:"moodle_stripepayment_process_payment",args:{userid:e,couponid:n,instanceid:o}}])[0])(e,n,o);t.error?.message?d("paymentresponse",t.error.message,"error"):"success"===t.status&&t.redirecturl?window.location.href=t.redirecturl:d("paymentresponse",unknownpaymenterror,"error")}catch(e){d("paymentresponse",e.message,"error")}};[{id:"apply",event:"click",handler:y},{id:"enrolbutton",event:"click",handler:w}].forEach(({id:e,event:n,handler:o})=>{const t=a(e);t&&t.addEventListener(n,o)}),s.default.get_strings([{key:"pleasewait",component:"enrol_stripepayment"},{key:"entercoupon",component:"enrol_stripepayment"},{key:"couponappling",component:"enrol_stripepayment"},{key:"couponapply",component:"enrol_stripepayment"},{key:"couponappliedsuccessfully",component:"enrol_stripepayment"},{key:"enrolnow",component:"enrol_stripepayment"},{key:"invalidserverresponse",component:"enrol_stripepayment"},{key:"unknownpaymenterror",component:"enrol_stripepayment"}]).then(e=>{p={pleasewait:e[0],entercoupon:e[1],couponappling:e[2],couponapply:e[3],couponappliedsuccessfully:e[4],enrolnow:e[5],invalidserverresponse:e[7],unknownpaymenterror:e[8]}}).catch(e=>{console.error("Failed to load localized strings:",e)})}}});
