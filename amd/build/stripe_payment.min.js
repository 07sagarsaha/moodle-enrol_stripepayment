define(["core/ajax"],function(e){"use strict";function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=t(e);const{call:o}=n.default,s=e=>{const t=new Map;return{getElement(n){const o=`${n}-${e}`;return t.has(o)||t.set(o,document.getElementById(o)),t.get(o)},setElement(e,t){const n=this.getElement(e);n&&(n.innerHTML=t)},toggleElement(e,t){const n=this.getElement(e);n&&(n.style.display=t?"block":"none")},focusElement(e){const t=this.getElement(e);t&&t.focus()},setButton(e,t,n,o=(t?"0.7":"1")){const s=this.getElement(e);s&&(s.disabled=t,s.textContent=n,s.style.opacity=o,s.style.cursor=t?"not-allowed":"pointer")}}};return{stripePayment:function(e,t,n,r,c,l,a,i){const u=s(n);if(void 0===window.Stripe)return;const d=(e,t,n)=>{let o;switch(n){case"error":o="red";break;case"success":o="green";break;default:o="blue"}u.setElement(e,`<p style="color: ${o}; font-weight: bold;">${t}</p>`),u.toggleElement(e,!0)},m=async e=>{e.preventDefault();const s=u.getElement("coupon"),r=s?.value.trim();if(!r)return d("showmessage",c,"error"),void u.focusElement("coupon");u.setButton("apply",!0,l);try{const e=await((e,t)=>o([{methodname:"moodle_stripepayment_apply_coupon",args:{couponid:e,instanceid:t}}])[0])(r,n);if(void 0===e?.discountedcost)throw new Error("Invalid server response");t=r,u.toggleElement("coupon",!1),u.toggleElement("apply",!1),p(e)}catch(e){d("showmessage",e.message,"error"),u.focusElement("coupon")}finally{u.setButton("apply",!1,a)}},p=e=>{u.toggleElement("discountsection",e.showsections.discountsection),e.showsections.discountsection&&(e.couponname&&u.setElement("discounttag",e.couponname),e.discountamount&&u.setElement("discountamountdisplay",e.discountamount),e.discountdisplay&&u.setElement("discountnote",e.discountdisplay),e.discountedcost&&u.setElement("totalamount",e.discountedcost),d("showmessage",i,"success")),u.setButton("enrolbutton",!1,"Enroll")};[{id:"apply",event:"click",handler:m},{id:"enrolbutton",event:"click",handler:async()=>{if(u.getElement("enrolbutton")){var s;s="paymentresponse",u.setElement(s,""),u.toggleElement(s,!1),u.setButton("enrolbutton",!0,r);try{const s=await((e,t,n)=>o([{methodname:"moodle_stripepayment_process_payment",args:{userid:e,couponid:t,instanceid:n}}])[0])(e,t,n);s.error?.message?d("paymentresponse",s.error.message,"error"):"success"===s.status&&s.redirecturl?window.location.href=s.redirecturl:d("paymentresponse","Unknown error occurred during payment.","error")}catch(e){d("paymentresponse",e.message,"error")}finally{u.toggleElement("enrolbutton",!1)}}}}].forEach(({id:e,event:t,handler:n})=>{const o=u.getElement(e);o&&o.addEventListener(t,n)})}}});
