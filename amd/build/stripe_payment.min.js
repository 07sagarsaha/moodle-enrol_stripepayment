define(["core/ajax"], function (ajax) {
  const { call: fetchMany } = ajax;

  // Repository functions following ajaxdoc guidelines
  const applyCoupon = (couponid, instanceid) =>
    fetchMany([{ methodname: "moodle_stripepayment_applycoupon", args: { couponid, instanceid } }])[0];

  const stripeenrol = (userid, couponid, instanceid) =>
    fetchMany([{ methodname: "moodle_stripepayment_enrol", args: { userid, couponid, instanceid } }])[0];

  // Optimized DOM utility with caching
  const createDOM = (instanceid) => {
    const cache = new Map();
    return {
      get(id) {
        const fullid = `${id}-${instanceid}`;
        if (!cache.has(fullid)) cache.set(fullid, document.getElementById(fullid));
        return cache.get(fullid);
      },
      setHTML(id, html) {
        const element = this.get(id);
        if (element) element.innerHTML = html;
      },
      toggle(id, show) {
        const element = this.get(id);
        if (element) element.style.display = show ? "block" : "none";
      },
      focus(id) {
        const element = this.get(id);
        if (element) element.focus();
      },
      setButtonState(id, disabled, text, opacity = disabled ? "0.7" : "1") {
        const button = this.get(id);
        if (button) {
          button.disabled = disabled;
          button.textContent = text;
          button.style.opacity = opacity;
          button.style.cursor = disabled ? "not-allowed" : "pointer";
        }
      },
    };
  };
  return {
    stripe_payment: function (userid, publishablekey, couponid, instanceid, pleasewaitstring) {
      // Create instance-specific DOM utility
      const DOM = createDOM(instanceid);
      // Initialize Stripe (global object loaded from external script)
      if (typeof window.Stripe === "undefined") {
        console.error("Stripe.js not loaded.");
        return;
      }
      const stripe = window.Stripe(publishablekey);
      // Simplified coupon application - PHP backend handles all logic
      const applyCouponHandler = async (event) => {
        event.preventDefault();
        const couponinput = DOM.get("coupon");
        const couponcode = couponinput?.value.trim();
        if (!couponcode) {
          displayMessage("showmessage", "Please enter a coupon code", "error");
          DOM.focus("coupon");
          return;
        }
        DOM.setButtonState("apply", true, "Applying...");
        try {
          const data = await applyCoupon(couponcode, instanceid);
          if (data?.status !== undefined) {
            couponid = couponcode;
            // Hide input group after success
            DOM.get("coupon")?.closest(".coupon-input-group")?.style.setProperty("display", "none");
            // Handle free auto-enrollment
            if (data.auto_enrolled) {
              displayMessage("showmessage", data.message || "Enrolled successfully!", "success");
              setTimeout(() => location.reload(), 1500);
              return;
            }
            updateUIFromServerResponse(data);// Handles rest of the update
          } else {
            throw new Error("Invalid server response");
          }
        } catch (error) {
          console.error("Coupon application failed:", error);
          displayMessage("showmessage", error.message || "Coupon validation failed", "error");
          DOM.focus("coupon");
        } finally {
          DOM.setButtonState("apply", false, "Apply code");
        }
      };

      const EnrollHandler = async () => {
        const enrollbutton = DOM.get("enrolbutton");
        if (!enrollbutton) return;
        clearError("paymentresponse");
        DOM.setButtonState("enrolbutton", true, pleasewaitstring);
        try {
          const paymentdata = await stripeenrol(userid, couponid, instanceid);
          if (paymentdata.error?.message) {
            displayMessage("paymentresponse", paymentdata.error.message, "error");
          } else if (paymentdata.status === "success" && paymentdata.redirecturl) {
            window.location.href = paymentdata.redirecturl;// Redirect browser to Stripe Checkout
          } else {
            displayMessage("paymentresponse", "Payment session creation failed.", "error");
          }
        } catch (err) {
          console.error("Enrollment failed:", err);
          displayMessage("paymentresponse", `Enrollment failed: ${err.message}`, "error");
        } finally {
          DOM.toggle("enrolbutton", false);
        }
      };

      const displayMessage = (containerid, message, type = "info") => {
        const color = type === "error" ? "red" : type === "success" ? "green" : "blue";
        DOM.setHTML(containerid, `<p style="color: ${color}; font-weight: bold;">${message}</p>`);
        DOM.toggle(containerid, true);
      };

      const clearError = (containerid) => {
        DOM.setHTML(containerid, "");
        DOM.toggle(containerid, false);
      };

      const updateUIFromServerResponse = (data) => {
        if (data.message) {
          displayMessage("showmessage", data.message, data.uistate === "error" ? "error" : "success");
        } else {
          clearError("showmessage");
        }
        DOM.toggle("enrolbutton", data.uistate === "paid");
        DOM.toggle("total", data.uistate === "paid");
        if (data.uistate !== "error") {
          DOM.toggle("discountsection", !!data.showsections?.discountsection);
          // Fill discount data
          if (data.showsections?.discountsection) {
            if (data.couponname) DOM.setHTML("discounttag", data.couponname);
            if (data.discountamount && data.currency) {
              DOM.setHTML("discountamountdisplay", `-${data.currency} ${parseFloat(data.discountamount).toFixed(2)}`);
            }
            if (data.discountamount && data.discountvalue) {
              const note = data.discountamount === "percent_off"
                ? `${data.discountvalue}% off`
                : `${data.currency} ${parseFloat(data.discountvalue).toFixed(2)} off`;
              DOM.setHTML("discountnote", note);
            }
          }
          if (data.status && data.currency) {
            const totalamount = DOM.get("totalamount");
            if (totalamount) totalamount.textContent = `${data.currency} ${parseFloat(data.status).toFixed(2)}`;
          }
        }
      };

      const setupEventListeners = () => {
        const elements = [
          { id: "apply", event: "click", handler: applyCouponHandler },
          { id: "enrolbutton", event: "click", handler: EnrollHandler },
        ];
        elements.forEach(({ id, event, handler }) => {
          const element = DOM.get(id);
          if (element) element.addEventListener(event, handler);
        });
      };

      setupEventListeners();
    },
  };
});