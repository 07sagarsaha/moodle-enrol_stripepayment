define(["core/ajax","core/str"],function(e,n){"use strict";function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var t=o(e),s=o(n);const{call:r}=t.default;let p={};return{stripePayment:(e,n)=>{console.log("stripePayment",e,n);const o=new Map,t=e=>{const t=`${e}-${n.id}`;return o.has(t)||o.set(t,document.getElementById(t)),o.get(t)},a=(e,n)=>{const o=t(e);o&&(o.innerHTML=n)},c=(e,n)=>{const o=t(e);o&&(o.style.display=n?"block":"none")},l=e=>{const n=t(e);n&&n.focus()},i=(e,n,o,s=(n?"0.7":"1"))=>{const r=t(e);r&&(r.disabled=n,r.textContent=o,r.style.opacity=s,r.style.cursor=n?"not-allowed":"pointer")},u=(e,n,o)=>{let t;switch(o){case"error":t="red";break;case"success":t="green";break;default:t="blue"}a(e,`<p style="color: ${t}; font-weight: bold;">${n}</p>`),c(e,!0)},d=async o=>{o.preventDefault();const s=t("coupon"),a=s?.value.trim();if(!a)return u("showmessage",p.entercoupon,"error"),void l("coupon");i("apply",!0,p.couponappling);try{const o=await((e,n)=>r([{methodname:"moodle_stripepayment_apply_coupon",args:{couponid:e,instance:n}}])[0])(a,n);if(void 0===o?.discountedprice)throw new Error(p.invalidserverresponse);e=a,c("coupon",!1),c("apply",!1),y(o)}catch(e){u("showmessage",e.message,"error"),l("coupon")}finally{i("apply",!1,p.couponapply)}},y=e=>{c("displaydiscountsection",e.displaydiscountsection),e.displaydiscountsection&&(a("discounttag",e.couponname),a("discountamountdisplay",e.discountamount),a("discountnote",e.discountmessage),a("totalamount",e.discountedprice),u("showmessage",p.couponappliedsuccessfully,"success")),i("enrolbutton",!1,p.enrolnow)},m=async()=>{var o;a(o="paymentresponse",""),c(o,!1),i("enrolbutton",!0,p.pleasewait);try{const o=await((e,n)=>r([{methodname:"moodle_stripepayment_process_payment",args:{couponid:e,instance:n}}])[0])(e,n);o.error?.message?u("paymentresponse",o.error.message,"error"):"success"===o.status&&o.redirecturl?window.location.href=o.redirecturl:u("paymentresponse",unknownpaymenterror,"error")}catch(e){u("paymentresponse",e.message,"error")}};[{id:"apply",event:"click",handler:d},{id:"enrolbutton",event:"click",handler:m}].forEach(({id:e,event:n,handler:o})=>{const s=t(e);s&&s.addEventListener(n,o)}),s.default.get_strings([{key:"pleasewait",component:"enrol_stripepayment"},{key:"entercoupon",component:"enrol_stripepayment"},{key:"couponappling",component:"enrol_stripepayment"},{key:"couponapply",component:"enrol_stripepayment"},{key:"couponappliedsuccessfully",component:"enrol_stripepayment"},{key:"enrolnow",component:"enrol_stripepayment"},{key:"invalidserverresponse",component:"enrol_stripepayment"},{key:"unknownpaymenterror",component:"enrol_stripepayment"}]).then(e=>{p={pleasewait:e[0],entercoupon:e[1],couponappling:e[2],couponapply:e[3],couponappliedsuccessfully:e[4],enrolnow:e[5],invalidserverresponse:e[7],unknownpaymenterror:e[8]}}).catch(e=>{console.error("Failed to load localized strings:",e)})}}});
