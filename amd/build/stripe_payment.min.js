define(["core/ajax"],function(e){"use strict";function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=t(e);const{call:o}=n.default,s=e=>{const t=new Map;return{getElement(n){const o=`${n}-${e}`;return t.has(o)||t.set(o,document.getElementById(o)),t.get(o)},setElement(e,t){const n=this.getElement(e);n&&(n.innerHTML=t)},toggleElement(e,t){const n=this.getElement(e);n&&(n.style.display=t?"block":"none")},focusElement(e){const t=this.getElement(e);t&&t.focus()},setButton(e,t,n,o=(t?"0.7":"1")){const s=this.getElement(e);s&&(s.disabled=t,s.textContent=n,s.style.opacity=o,s.style.cursor=t?"not-allowed":"pointer")}}};return{stripePayment:function(e,t,n,r,c,l,a){const i=s(n);if(void 0===window.Stripe)return;const u=(e,t,n)=>{let o;switch(n){case"error":o="red";break;case"success":o="green";break;default:o="blue"}i.setElement(e,`<p style="color: ${o}; font-weight: bold;">${t}</p>`),i.toggleElement(e,!0)},d=async e=>{e.preventDefault();const s=i.getElement("coupon"),r=s?.value.trim();if(!r)return u("showmessage",c,"error"),void i.focusElement("coupon");i.setButton("apply",!0,l);try{const e=await((e,t)=>o([{methodname:"moodle_stripepayment_applycoupon",args:{couponid:e,instanceid:t}}])[0])(r,n);if(void 0===e?.discountedcost)throw new Error("Invalid server response");t=r,i.toggleElement("coupon",!1),i.toggleElement("apply",!1),m(e)}catch(e){u("showmessage",e.message,"error"),i.focusElement("coupon")}finally{i.setButton("apply",!1,a)}},m=e=>{i.toggleElement("discountsection",e.showsections.discountsection),e.showsections.discountsection&&(e.couponname&&i.setElement("discounttag",e.couponname),e.discountamount&&i.setElement("discountamountdisplay",e.discountamount),e.discountdisplay&&i.setElement("discountnote",e.discountdisplay),e.discountedcost&&i.setElement("totalamount",e.discountedcost),u("showmessage","","success")),i.setButton("enrolbutton",!1,"Enroll")};[{id:"apply",event:"click",handler:d},{id:"enrolbutton",event:"click",handler:async()=>{if(i.getElement("enrolbutton")){var s;s="paymentresponse",i.setElement(s,""),i.toggleElement(s,!1),i.setButton("enrolbutton",!0,r);try{const s=await((e,t,n)=>o([{methodname:"moodle_stripepayment_process_payment",args:{userid:e,couponid:t,instanceid:n}}])[0])(e,t,n);s.error?.message?u("paymentresponse",s.error.message,"error"):"success"===s.status&&s.redirecturl?window.location.href=s.redirecturl:u("paymentresponse","Unknown error occurred during payment.","error")}catch(e){u("paymentresponse",e.message,"error")}finally{i.toggleElement("enrolbutton",!1)}}}}].forEach(({id:e,event:t,handler:n})=>{const o=i.getElement(e);o&&o.addEventListener(t,n)})}}});
