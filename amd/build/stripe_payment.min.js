define(function(){"use strict";define(["core/ajax"],function(e){const{call:t}=e,n=e=>{const t=new Map;return{getelement(n){const o=`${n}-${e}`;return t.has(o)||t.set(o,document.getElementById(o)),t.get(o)},setelement(e,t){const n=this.getelement(e);n&&(n.innerHTML=t)},toggleelement(e,t){const n=this.getelement(e);n&&(n.style.display=t?"block":"none")},focuselement(e){const t=this.getelement(e);t&&t.focus()},setbutton(e,t,n,o=(t?"0.7":"1")){const s=this.getelement(e);s&&(s.disabled=t,s.textContent=n,s.style.opacity=o,s.style.cursor=t?"not-allowed":"pointer")}}};return{stripe_payment:function(e,o,s,r,c,a,l){const i=n(r);if(void 0===window.Stripe)return;const u=async e=>{e.preventDefault();const n=i.getelement("coupon"),o=n?.value.trim();if(!o)return d("showmessage",a,"error"),void i.focuselement("coupon");i.setbutton("apply",!0,l);try{const e=await((e,n)=>t([{methodname:"moodle_stripepayment_applycoupon",args:{couponid:e,instanceid:n}}])[0])(o,r);if(void 0===e?.status)throw new Error("Invalid server response");s=o,i.toggleelement("coupon",!1),i.toggleelement("apply",!1),g(e)}catch(e){d("showmessage",e.message||"Coupon validation failed","error"),i.focuselement("coupon")}},m=async()=>{if(i.getelement("enrolbutton")){p("paymentresponse"),i.setbutton("enrolbutton",!0,c);try{const n=await((e,n,o)=>t([{methodname:"moodle_stripepayment_enrol",args:{userid:e,couponid:n,instanceid:o}}])[0])(e,s,r);n.error?.message?d("paymentresponse",n.error.message,"error"):"success"===n.status&&n.redirecturl?window.location.href=n.redirecturl:d("paymentresponse","Unknown error occurred during payment.","error")}catch(e){d("paymentresponse",e.message,"error")}finally{i.toggleelement("enrolbutton",!1)}}},d=(e,t,n)=>{let o;switch(n){case"error":o="red";break;case"success":o="green";break;default:o="blue"}i.setelement(e,`<p style="color: ${o}; font-weight: bold;">${t}</p>`),i.toggleelement(e,!0)},p=e=>{i.setelement(e,""),i.toggleelement(e,!1)},g=e=>{if(e.message?d("showmessage",e.message,"error"===e.uistate?"error":"success"):p("showmessage"),i.toggleelement("enrolbutton","paid"===e.uistate),i.toggleelement("total","paid"===e.uistate),"error"!==e.uistate){if(i.toggleelement("discountsection",e.showsections.discountsection),e.showsections.discountsection&&(e.couponname&&i.setelement("discounttag",e.couponname),e.discountamount&&e.currency&&i.setelement("discountamountdisplay",`-${e.currency} ${e.discountamount}`),e.discountamount&&e.discountvalue)){const t="percentoff"===e.coupontype?`${e.discountvalue}% off`:`${e.currency} ${e.discountvalue} off`;i.setelement("discountnote",t)}if(e.status&&e.currency){const t=i.getelement("totalamount");t&&(t.textContent=`${e.currency} ${parseFloat(e.status).toFixed(2)}`)}}};[{id:"apply",event:"click",handler:u},{id:"enrolbutton",event:"click",handler:m}].forEach(({id:e,event:t,handler:n})=>{const o=i.getelement(e);o&&o.addEventListener(t,n)})}}})});
